In this tutorial we create and score a test for MCAS 4th grade ELA,
using simulated student responses, and released questions from 2018.

Ingredients:
============

1.  Released test questions (items) to create the test, like these:
    <a href="https://mcas.digitalitemlibrary.com/home?subject=ELA&amp;grades=Grade%204&amp;view=ALL" class="uri">https://mcas.digitalitemlibrary.com/home?subject=ELA&amp;grades=Grade%204&amp;view=ALL</a>

2.  Released item IRT parameters, like table M5 here:
    <a href="http://www.mcasservicecenter.com/documents/MA/Technical%20Report/2018/NextGen/Appendix%20M%20-%20Plots%20and%20IRT%20Parameters.pdf" class="uri">http://www.mcasservicecenter.com/documents/MA/Technical%20Report/2018/NextGen/Appendix%20M%20-%20Plots%20and%20IRT%20Parameters.pdf</a>
    Example file saved as “tablem5.xlsx”

3.  Common item numbers/identifiers that relate each question (item) to
    its parameters: currently missing for MCAS

4.  Student responses for each of the test questions, graded as
    correct/incorrect: we simulate fake data below (Note: we plan to add
    code that could estimate student ability using only sum-scores,
    rather than full-pattern scores)

5.  A table that converts theta scores to scale scores (and possibly
    also achievement levels), like table N2, here:
    <a href="http://www.mcasservicecenter.com/documents/MA/Technical%20Report/2018/NextGen/Appendix%20N%20-%20Scaled%20Score%20Distributions%20and%20Look-up%20Tables_4.17.19.pdf" class="uri">http://www.mcasservicecenter.com/documents/MA/Technical%20Report/2018/NextGen/Appendix%20N%20-%20Scaled%20Score%20Distributions%20and%20Look-up%20Tables_4.17.19.pdf</a>
    Example file saved as “tablen2.xlsx”

Progress:
=========

Implemented so far:
-------------------

-   Import 3PL item parameters
-   Import theta to scale score table
-   Simulate student responses, as full-pattern 0/1 scores
-   Estimate student ability on theta scale
-   Convert theta scores to scale scores
-   Estimate achievement levels for cutoffs known/given for scale scores
-   Export student ability data, including thetas, scale scores, and
    achievement levels
-   Report Classical Test Theory statistics
-   Plot Item Characteristic Curves and Test Characteristic Curve
-   Plot Item Information Functions and Test Information Function

To do next:
-----------

-   Report standard errors on scale scores if possible?

Cool, harder to-dos:
--------------------

-   How should I think about standard errors on theta scale from ability
    estimation and the scale-score standard errors MCAS released? How
    should I report and explain standard errors?
-   Implement sum scores -&gt; scale scores methodology (estimation,
    probably sans standard errors)
-   Add support for polytomously scored items? (Hand-scored, GRM stuff
    for MCAS)

Future extras/usability extensions:
-----------------------------------

-   Extend functionality for 1PL and 2PL parameters, if that’s how a
    different state does things (possibly just zero out the c column)
-   Add code to import student responses, including student
    names/identifiers to attach to the thetas, scale scores, and
-   Add code to dichotomously score multi-choice questions if a key is
    provided (functions already exist for this, eg. irtoys::sco)

``` r
# Import item parameter data
item_parameters_raw <- read_excel("tablem5.xlsx")                            

# Separate the item parameters from the standard errors
my_ip <- as.matrix(item_parameters_raw  %>% dplyr::select(a, b, c))               
my_se <- as.matrix(item_parameters_raw  %>% dplyr::select("se(a)", "se(b)", "se(c)"))

# Import student responses (if using real data)
# Note: use the "upload" function next to the file menu in the window on the right hand side of the console

# Import theta -> scale score table
scale_scores_raw <- read_excel("tablen2.xlsx")

# Select the relevant columns:
scale_scores <- scale_scores_raw  %>% dplyr::select("Theta", "Scale Score (2018)")

# Plot relationship between thetas and scale scores:
plot(x = scale_scores$Theta, y = scale_scores$`Scale Score (2018)`)
```

![](open-tests_files/figure-markdown_github/unnamed-chunk-2-1.png)

``` r
# Relationship is a straight line! Learn the model so we can make this conversion ourselves, later.
theta_to_scale_score <- lm(`Scale Score (2018)` ~ Theta, data = scale_scores)
summary(theta_to_scale_score)
```

    ## 
    ## Call:
    ## lm(formula = `Scale Score (2018)` ~ Theta, data = scale_scores)
    ## 
    ## Residuals:
    ##      Min       1Q   Median       3Q      Max 
    ## -0.48284 -0.21294 -0.04279  0.35221  0.49858 
    ## 
    ## Coefficients:
    ##              Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept) 499.42554    0.04645 10751.0   <2e-16 ***
    ## Theta        18.85391    0.02377   793.3   <2e-16 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 0.2994 on 43 degrees of freedom
    ## Multiple R-squared:  0.9999, Adjusted R-squared:  0.9999 
    ## F-statistic: 6.294e+05 on 1 and 43 DF,  p-value: < 2.2e-16

``` r
# Use parameter estimates to simulate answers for 100 students
set.seed(88)
sim_thetas <- rnorm(100)
sim_responses <- sim(my_ip, sim_thetas)

# Put the parameter estimates and standard errors into the list structure that irtoys functions expect
# Note: ability estimation function does not need standard errors to run
parameter_list <- list(est = my_ip, se = my_se, vcm = NA)

# Estimate student thetas, based on full-pattern scoring, using MLE (several other methods exist in this "ability" function)
mod_MLE<- ability(resp = sim_responses, ip = parameter_list, method = "MLE")

# Look at the first five rows
mod_MLE[1:5, ]
```

    ##             est       sem  n
    ## [1,]  1.1946366 1.0862808 15
    ## [2,]  1.3731005 1.1410868 15
    ## [3,]  3.9999198 2.3626913 15
    ## [4,] -0.7922178 0.7661342 15
    ## [5,] -0.4550526 0.7780056 15

``` r
# Convert these estimated thetas to scale scores and achievement levels
ability_df <- as.data.frame(mod_MLE)
colnames(ability_df) <- c("Theta", "se(Theta)", "n")
ability_df$ScaleScore <- predict(theta_to_scale_score, newdata = ability_df)

# Look at the first five rows, with scale scores
ability_df[1:5, ]
```

    ##        Theta se(Theta)  n ScaleScore
    ## 1  1.1946366 1.0862808 15   521.9491
    ## 2  1.3731005 1.1410868 15   525.3138
    ## 3  3.9999198 2.3626913 15   574.8396
    ## 4 -0.7922178 0.7661342 15   484.4891
    ## 5 -0.4550526 0.7780056 15   490.8460

``` r
# Add achievement levels, based on known scale score cutoffs
ability_df$AchievementLevel <- 1
ability_df$AchievementLevel[ability_df$ScaleScore > 470] <- 2
ability_df$AchievementLevel[ability_df$ScaleScore > 500] <- 3
ability_df$AchievementLevel[ability_df$ScaleScore > 530] <- 4

# Look at the data again
ability_df[1:5, ]
```

    ##        Theta se(Theta)  n ScaleScore AchievementLevel
    ## 1  1.1946366 1.0862808 15   521.9491                3
    ## 2  1.3731005 1.1410868 15   525.3138                3
    ## 3  3.9999198 2.3626913 15   574.8396                4
    ## 4 -0.7922178 0.7661342 15   484.4891                2
    ## 5 -0.4550526 0.7780056 15   490.8460                2

``` r
# Round the scale scores to 0 dp before reporting
ability_df$ScaleScore <- round(ability_df$ScaleScore, 0)

# Final check:
ability_df[1:5, ]
```

    ##        Theta se(Theta)  n ScaleScore AchievementLevel
    ## 1  1.1946366 1.0862808 15        522                3
    ## 2  1.3731005 1.1410868 15        525                3
    ## 3  3.9999198 2.3626913 15        575                4
    ## 4 -0.7922178 0.7661342 15        484                2
    ## 5 -0.4550526 0.7780056 15        491                2

``` r
# Export the data 
write.csv(ability_df, file = "EstimatedScores.csv", row.names = F)
# The above file will appear in the file window on the bottom-right hand side of the screen
# To download to local computer, select this file using the checkbox, then use More...Export...
```

Diagnostics:

``` r
# Classical Test Theory EDA metrics:
# Note: Because the simulated data is pre-graded, we're saying the "answer key" is 1, 1, 1, 1, 1....
ctt <- tia(sim_responses, key = rep(1, 15))

# Show Cronbach's alpha for this "test":
ctt$testlevel$alpha
```

    ## [1] 0.476776

``` r
# Show CTT item-level statistics for first five items
ctt$itemlevel[1:5, ]
```

    ##       Prop. correct Item-sum cor. Alpha without
    ## Item1          0.70     0.3062258     0.4161638
    ## Item2          0.56     0.3015503     0.4131231
    ## Item3          0.59     0.3916676     0.3820999
    ## Item4          0.73     0.3936733     0.3912438
    ## Item5          0.52     0.3779185     0.3856171

``` r
# How does the MLE ability estimation perform compared to the "true thetas" from our simulation?
cor(mod_MLE[,1], sim_thetas)
```

    ## [1] 0.733215

``` r
plot(sim_thetas, mod_MLE[,1])
```

![](open-tests_files/figure-markdown_github/unnamed-chunk-4-1.png)

``` r
# How do other ability estimation methods perform?
mod_WLE <- ability(resp = sim_responses, ip = parameter_list, method = "WLE")
cor(mod_WLE[,1], sim_thetas)
```

    ## [1] 0.7343091

``` r
plot(sim_thetas, mod_WLE[,1])
```

![](open-tests_files/figure-markdown_github/unnamed-chunk-4-2.png)

``` r
# Item Characteristic Curves for first five items (this package calls them "item response functions")
plot(irf(my_ip, items = 1:5), co = NA, label = T)
```

![](open-tests_files/figure-markdown_github/unnamed-chunk-4-3.png)

``` r
# ICCs for all items:
plot(irf(my_ip), co = NA, label = T)
```

![](open-tests_files/figure-markdown_github/unnamed-chunk-4-4.png)

``` r
# Test Characteristic Curve (this package calls this a "test response function")
plot(trf(my_ip))
```

![](open-tests_files/figure-markdown_github/unnamed-chunk-4-5.png)

``` r
# Overlaid item information curves
plot(iif(my_ip))
```

![](open-tests_files/figure-markdown_github/unnamed-chunk-4-6.png)

``` r
# Test information function
plot(tif(my_ip))
```

![](open-tests_files/figure-markdown_github/unnamed-chunk-4-7.png)

``` r
# Cool plot of observed sum scores and predicted sum scores against estimated ability, with +/- 1se bands
scp(sim_responses, my_ip)
```

![](open-tests_files/figure-markdown_github/unnamed-chunk-4-8.png)

``` r
# "Empirical response function" for a selected item: observed sum scores vs. percent correct on this question
erf(sim_responses, 1)
```

![](open-tests_files/figure-markdown_github/unnamed-chunk-4-9.png)

    ##     x         y
    ## 5   5 0.2500000
    ## 6   6 0.5000000
    ## 7   7 0.7142857
    ## 8   8 0.5000000
    ## 9   9 0.6666667
    ## 10 10 0.6428571
    ## 11 11 0.6666667
    ## 12 12 0.8333333
    ## 13 13 1.0000000
    ## 14 14 0.7500000
    ## 15 15 1.0000000
