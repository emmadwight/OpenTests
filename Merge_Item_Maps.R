#read in required packages
library(readxl)
library(tidyverse)

# Create a list of the files from your target directory, which contains (only) item maps xlxs files
# We use NAEP Grade 4 Math item maps from across the years
file_list <- list.files("NAEP_Item_Maps")

# Initiate a blank data frame
combined_item_maps <- data.frame()

# Loop through the files, append them to the bottom of  combined_item_maps
for (i in 1:length(file_list)){
  temp_data <- read_excel(paste0("NAEP_Item_Maps/", file_list[i]))
  useful_data <- temp_data[17:(nrow(temp_data)-4), 1:3]
  colnames(useful_data) <- c("Content_Classification", "Scale_Score", "Question")
  year_string <- as.character(temp_data[7,1])
  useful_data$Year <- as.numeric(str_sub(year_string, start= -4))
  combined_item_maps <- rbind(combined_item_maps, useful_data) #for each iteration, bind the new data to the building dataset
}

# Obviously, change these mappings for ELA
combined_item_maps$Content_Classification <- str_replace(
  combined_item_maps$Content_Classification, 
  "●", "Number Properties and Operations")
combined_item_maps$Content_Classification <- str_replace(
  combined_item_maps$Content_Classification, 
  "■", "Measurement")
combined_item_maps$Content_Classification <- str_replace(
  combined_item_maps$Content_Classification, 
  "▲", "Geometry")
combined_item_maps$Content_Classification <- str_replace(
  combined_item_maps$Content_Classification, 
  "▼", "Data Analysis, Statistics, and Probability")
combined_item_maps$Content_Classification <- str_replace(
  combined_item_maps$Content_Classification, 
  "◆", "Algebra")
# Weird behaviours with em-dashes:
combined_item_maps$Question <- str_replace(
  combined_item_maps$Question, 
  "—", "-")

# Drop the level boundary rows (which duplicated)
combined_item_maps <- combined_item_maps[!is.na(combined_item_maps$Scale_Score), ]

# Put the level boundary rows back in
boundaries <- data.frame(Content_Classification = rep(NA, 3),
                         Scale_Score = c(282, 249, 214),
                         Question = c("NAEP Advanced", "NAEP Proficient", "NAEP Basic"),
                         Year = rep(NA, 3))
combined_item_maps <- rbind(combined_item_maps, boundaries)

# Sort by scale score
final <- combined_item_maps %>% arrange(desc(Scale_Score), Content_Classification)

# Export out the combined item map
write.csv(final, file = "data/Combined_Item_Maps.csv", row.names = F)
